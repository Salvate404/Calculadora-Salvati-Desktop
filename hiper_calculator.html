<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora - Hiper</title>
    <link rel="icon" type="image/png" href="IMG/imgfavicon.png">

    <script>
        // --- LÓGICA DE VERIFICAÇÃO DE TIPO DE USUÁRIO (SEM CONTROLE DE SESSÃO POR TEMPO) ---
        const tipoUsuario = localStorage.getItem('tipoUsuario'); // Pega o tipo de usuário

        if (tipoUsuario !== 'hiper') { // Verifica se é o tipo correto para este arquivo
            console.log("Tipo de usuário incorreto. Redirecionando para login.");
            localStorage.removeItem('usuarioLogado');
            localStorage.removeItem('tempoLogin');
            localStorage.removeItem('tipoUsuario');
            window.location.href = 'login.html'; // Permanece indo para login.html aqui
        }

        // MUDANÇA AQUI: A função agora aceita um parâmetro 'urlDestino'
        function addExitAnimationAndRedirect(urlDestino) {
            document.body.classList.add('fade-zoom-out');
            // Espera a animação terminar antes de redirecionar
            setTimeout(() => {
                localStorage.removeItem('tipoUsuario'); // Limpa o tipo de usuário ao deslogar
                localStorage.removeItem('usuarioLogado'); // Boas práticas: limpa tudo relacionado ao login
                localStorage.removeItem('tempoLogin'); // Boas práticas: limpa tudo relacionado ao login
                window.location.href = 'menu.html'; // <--- USA O PARÂMETRO urlDestino
            }, 500); // Duração da animação (0.5s)
        }
    </script>


    <style>
        /* --- ESTILOS CSS EMBUTIDOS --- */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: #333;

            /* --- IMAGEM DE FUNDO DA TELA --- */
            background-image: url(IMG/imgsalvati.png);
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;

            /* --- REMOVER ROLAGEM VERTICAL DO BODY --- */
            overflow: hidden;
            position: relative;

            /* --- ANIMAÇÃO DE ENTRADA (FADE-IN COM LEVE ZOOM) --- */
            opacity: 0;
            transform: scale(5.00);
            animation: fadeZoomIn 1.0s ease-out forwards;
        }

        @keyframes fadeZoomIn {
            from { opacity: 0; transform: scale(1.05); }
            to { opacity: 1; transform: scale(1); }
        }

        /* --- ANIMAÇÃO DE SAÍDA (FADE-OUT COM LEVE ZOOM) --- */
        body.fade-zoom-out {
            animation: fadeZoomOut 0.5s ease-in forwards;
        }

        @keyframes fadeZoomOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }

        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 800px;
            text-align: center;
            
            max-height: calc(100vh - 40px);
            overflow-y: auto;
            box-sizing: border-box;
        }

        .help-box {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 350px;
            height: fit-content;
            text-align: left;
            display: none;
            z-index: 1000;
            position: absolute;
        }

        /* Estilos para o posicionamento dos help-box */
        #help-box-cortina {
            left: -400px;
            top: 0;
        }

        #help-box-capota {
            right: -400px;
            top: 0;
        }

        .header-title-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 25px;
            gap: 10px;
            padding-top: 30px;
        }

        .header-title-wrapper img {
            max-height: 100px;
            width: auto;
            margin-bottom: 10px;
        }

        .header-title-wrapper h1 {
            color: #000000;
            font-size: 1.8em;
            margin: 0;
            padding: 0;
            line-height: 1.2;
            display: block;
        }

        .input-group-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .input-group-row .input-group {
            flex: 1;
            min-width: 200px;
            margin-bottom: 0;
        }

        .input-group, .select-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .result-area {
            margin-bottom: 20px;
            text-align: center;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: bold;
        }

        input, select {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
            box-sizing: border-box;
        }

        .option-buttons {
            display: flex;
            justify-content: space-around;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .option-buttons button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease, box-shadow 0.2s ease;
            flex: 1;
            min-width: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .option-buttons button:hover {
            background-color: #0056b3;
        }

        .option-buttons button.selected {
            background-color: #28a745;
            box-shadow: 0 0 0 2px #28a745, 0 0 0 4px rgba(40, 167, 69, 0.5);
        }

        .option-buttons IMG/img {
            width: 30px;
            height: 30px;
            vertical-align: middle;
            border-radius: 3px;
        }

        .price-list div {
            margin-bottom: 5px;
        }
        
        .lona-selection-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .lona-selection-wrapper select {
            flex-grow: 1;
            margin-bottom: 0;
        }

        .palette-button {
            background-color: #007bff;
            color: #ffffff;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: none;
            transition: background-color 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .palette-button:hover {
            background-color: #0056b3;
        }

        /* --- ESTILOS PARA OS DETALHES DO CÁLCULO (AJUSTADO) --- */
        .result-details {
            background-color: #e9ecef;
            padding: 10px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #e0e0e0;
            
            display: flex;
            justify-content: space-around; /* Distribui o espaço entre os itens */
            flex-wrap: wrap; /* Permite que os itens quebrem a linha se não houver espaço */
            gap: 10px; /* Espaço entre os itens */
        }

        .result-details .spec-item {
            display: flex;
            flex-direction: row;
            align-items: center;
            text-align: center;
            font-size: 0.95em;
            /* Flex-basis para definir uma largura mínima, para evitar que fiquem muito estreitos */
            flex-basis: 'width'; /* 4 itens por linha, com um pouco de espaço entre eles */
            min-width: 10px; /* Largura mínima para cada item */
        }

        .result-details .spec-item strong {
            display: block;
            margin-bottom: 'length-percentage';
            color: #555;
            font-weight: bold;
            white-space: nowrap; /* Impede que o título quebre a linha */
        }
        
        .result-area {
            background-color: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.5em;
            font-weight: bold;
            margin-top: 30px;
            border: 1px solid #c3e6cb;
        }

        #logoutButton {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
            text-decoration: none;
            display: inline-block;
            z-index: 10;
        }

        #logoutButton:hover {
            background-color: #c82333;
        }

        #userTypeDisplay {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: white;
            font-size: 0.85em;
            font-weight: normal;
            z-index: 10;
        }

        .help-box-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        .help-box-item input[type="checkbox"] {
            margin-right: 10px;
            cursor: pointer;
        }
        .help-box-item label {
            flex-grow: 1;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header-title-wrapper">
            <IMG/img src="IMG/imglogo.png" alt="Logo da Empresa">
        </div>
        <div class="input-group-row">
            <div class="input-group">
                <label for="largura">Largura:</label>
                <input type="text" id="largura" placeholder="0,00" value="0,00" oninput="formatarMedida(this)">
            </div>

            <div class="input-group">
                <label id="medidaSecundariaLabel" for="medidaSecundaria">Caimento (Sem bandô):</label>
                <input type="text" id="medidaSecundaria" placeholder="0,00" value="0,00" oninput="formatarMedida(this)">
            </div>
        </div>

        <div class="select-group">
            <div class="option-buttons">
                <button id="btnCompleto" data-type="completo">
                    Completo
                </button>
            </div>
            <div class="option-buttons">
                <button id="btnCortina" data-type="cortina" class="selected">
                    Cortina
                </button>
                <button id="btnCapota" data-type="capota">
                    Capota
                </button>
            </div>
        </div>

        <div id="tipoPrecoSection" class="select-group">
            <div class="option-buttons">
                <button id="btnAtacado" data-price-type="atacado" class="selected">
                    Atacado
                </button>
                <button id="btnVarejo" data-price-type="varejo">
                    Varejo
                </button>
            </div>
        </div>

        <div id="help-box-articulado" class="help-box">
            <h3 id="help-box-articulado-title">O kit Articulado compõe:</h3>
            <div id="help-box-articulado-content"></div>
        </div>

        <div id="help-box-motor" class="help-box">
            <h3 id="help-box-motor-title">O kit Motor compõe:</h3>
            <div id="help-box-motor-content"></div>
        </div>

        <div class="select-group">
            <label for="marcaLona">Marca da Lona:</label>
            <div class="lona-selection-wrapper">
                <select id="marcaLona"></select>
                <button id="btnVerPaleta" class="palette-button">Paleta🎨</button>
            </div>
            <div id="priceList" class="price-list"></div> <!-- Este elemento parece não ser usado -->
        </div>

        <div id="resultDetails" class="result-details">
            </div>

        <div class="result-area">
            Valor do toldo: <span id="valorTotal">R$ 0,00</span>
        </div>
    </div>

    <a href="#" id="logoutButton" onclick="event.preventDefault(); addExitAnimationAndRedirect();">menu</a>
    <span id="userTypeDisplay"></span>


    <script>
        // --- FUNÇÕES DE FORMATAÇÃO E OBTENÇÃO DE VALOR NUMÉRICO ---
        function formatarMedida(inputElement) {
            let valor = inputElement.value;
            valor = valor.replace(/\D/g, '');
            if (valor.length === 0) {
                valor = '0';
            }
            let numValue = parseInt(valor, 10);
            if (numValue === 0) {
                valor = '000';
            } else {
                valor = numValue.toString();
                while (valor.length < 3) {
                    valor = '0' + valor;
                }
            }

            const kitData = {
            'cortina': {
                basePrice: { atacado: 0.00, varejo: 0.00 },
                components: [
                    { id: 'braço-200-kit', name: 'Braço articulado 2,00m', code: '3571', price: { atacado: 550.00, varejo: 700.00 }, checked: true, isArm: true },
                ]
            },
            'capota': {
                basePrice: { atacado: 0.00, varejo: 0.00 },
                components: [
                    { id: 'motor-100n-bucha', name: 'bucha', code: '3598', price: { atacado: 0.00, varejo: 31.03 }, checked: true },
                ]
            }
        };

        const articuladoButtons = document.querySelectorAll('.option-buttons-articulado button');
        const motorButtons = document.querySelectorAll('.option-buttons-motor button');
        const clienteButtons = document.querySelectorAll('.option-buttons-tipo-cliente button');
        const larguraInput = document.getElementById('largura-input');
        const caimentoInput = document.getElementById('caimento-input');

        const helpBoxArticulado = document.getElementById('help-box-articulado');
        const helpBoxMotor = document.getElementById('help-box-motor');
        const helpBoxArticuladoContent = document.getElementById('help-box-articulado-content');
        const helpBoxMotorContent = document.getElementById('help-box-motor-content');

        const valueLabel = document.getElementById('value-label');

        let selectedArticuladoKit = null;
        let selectedMotorKit = null;


            const parteInteira = valor.slice(0, -2);
            const parteDecimal = valor.slice(-2);
            const valorFormatado = `${parteInteira === '' ? '0' : parteInteira},${parteDecimal}`;
            inputElement.value = valorFormatado;
            calcularPreco();
        }

        function getNumericValue(elementId) {
            const inputElement = document.getElementById(elementId);
            if (!inputElement) return 0;
            let valorFormatado = inputElement.value;
            valorFormatado = valorFormatado.replace(',', '.');
            return parseFloat(valorFormatado) || 0;
        }

        // Referências aos elementos HTML
        const larguraInput = document.getElementById('largura');
        const medidaSecundariaInput = document.getElementById('medidaSecundaria');
        const medidaSecundariaLabel = document.getElementById('medidaSecundariaLabel');
        const tipoToldoButtons = document.querySelectorAll('.option-buttons button[data-type]');
        const marcaLonaSelect = document.getElementById('marcaLona');
        const priceListDiv = document.getElementById('priceList'); // Não usado, pode ser removido
        const valorTotalSpan = document.getElementById('valorTotal');
        const userTypeDisplay = document.getElementById('userTypeDisplay');
        const resultDetailsDiv = document.getElementById('resultDetails');
        const tipoCompletoButton = document.getElementById('btnCompleto');
        const tipoCortinaButton = document.getElementById('btnCortina');
        const tipoCapotaButton = document.getElementById('btnCapota');
        const btnVerPaleta = document.getElementById('btnVerPaleta');

        const tipoPrecoSection = document.getElementById('tipoPrecoSection');
        const precoButtons = document.querySelectorAll('#tipoPrecoSection .option-buttons button');


        const tipoUsuarioAtual = localStorage.getItem('tipoUsuario');
        console.log(`Calculadora carregada para o usuário do tipo: ${tipoUsuarioAtual}`);

        // --- Variáveis de estado global ---
        let tipoToldoSelecionado = 'cortina'; // Corrigido para começar com 'cortina'
        let tipoPrecoSelecionado = 'atacado';
        let isCompletoSelecionado = false;

        let LONA_PADRAO_LARGURA_CORTINA = 1.40;
        let LONA_PADRAO_LARGURA_CAPOTA = 1.40;

        // --- Estrutura de configurações para cada tipo de usuário/preço ---
        const CONFIGURACOES_USUARIO = {
            'hiper': {
                'atacado': {
                    PRECOS_LONA: {
                        "Sansuy: R$ 35,70": 35.70,
                        "Lowick: R$ 30,00": 30.00,
                        "Night&day: R$ 30,00": 30.00,
                        "SL: R$ 27,05": 27.05,
                        "Cristal: R$ 26,24": 26.24,
                        "Slim: R$ 22,16": 22.16,
                        "TD60: R$ 18,00": 18.00
                    },
                    CORTINA_COSTURA_M2_RATE: 4.50,
                    CAPOTA_COSTURA_M2_RATE: 15.50,
                    PRECO_MIN_COSTURA_CORTINA: 35.00,
                    PRECO_MIN_COSTURA_CAPOTA: 45.00,
                    LARGURA_PADRAO_LONA_GERAL: 1.40,
                    LARGURA_PADRAO_LONA_SANSUY: 1.45
                },
                'varejo': {
                    PRECOS_LONA: {
                        "Sansuy: R$ 42,50": 42.50,
                        "Lowick: R$ 35,00": 35.00,
                        "Night&day: R$ 35,00": 35.00,
                        "SL: R$ 29,00": 29.00,
                        "Cristal: R$ 35,00": 35.00,
                        "Slim: R$ 23,00": 23.00,
                        "TD60: R$ 23,00": 23.00
                    },
                    CORTINA_COSTURA_M2_RATE: 6.00,
                    CAPOTA_COSTURA_M2_RATE: 20.00,
                    PRECO_MIN_COSTURA_CORTINA: 45.00,
                    PRECO_MIN_COSTURA_CAPOTA: 50.00,
                    LARGURA_PADRAO_LONA_GERAL: 1.40,
                    LARGURA_PADRAO_LONA_SANSUY: 1.45
                }
            }
        };

        const PRECOS_COMPLETO_CORTINA = {
            "Sansuy: R$ 120,00": 120.00,
            "Lowick: R$ 100,00": 100.00,
            "Night&day: R$ 120,00": 120.00,
            "SL: R$ 100,00": 100.00,
            "Cristal: R$ 120,00": 120.00,
            "Slim: R$ 90,00": 90.00,
            "TD60: R$ 90,00": 90.00
        };

        const PRECOS_COMPLETO_CAPOTA = {
            "Sansuy: R$ 500,00": 500.00,
            "Lowick: R$ 500,00": 500.00,
            "Night&day: R$ 500,00": 500.00,
            "SL: R$ 500,00": 500.00,
            "Cristal: R$ 500,00": 500.00,
            "Slim: R$ 500,00": 500.00,
            "TD60: R$ 500,00": 500.00
        };

        let currentConfig = {};
        let currentPrecosLona = {};

        const paletaMap = {
            'sansuy': 'PDF/paleta-sansuy.pdf',
            'lowick': 'PDF/paleta-lowick.pdf',
            'night&day': 'PDF/paleta-nightday.pdf',
            'sl': 'PDF/paleta-sl.pdf',
            'cristal': 'PDF/paleta-cristal.pdf',
            'slim': 'PDF/paleta-slim.pdf',
            'td60': 'PDF/paleta-td60.pdf'
        };


        function loadUserConfig() {
            const lonaAnteriormenteSelecionada = marcaLonaSelect.value;
            
            if (tipoUsuarioAtual === 'hiper') {
                tipoPrecoSection.style.display = 'block';
                userTypeDisplay.textContent = 'vsHiper';
                
                if (!tipoPrecoSelecionado) {
                    tipoPrecoSelecionado = 'atacado'; // Garante um valor padrão
                }
                
                precoButtons.forEach(btn => btn.classList.remove('selected'));
                const activePriceButton = document.querySelector(`#tipoPrecoSection button[data-price-type="${tipoPrecoSelecionado}"]`);
                if (activePriceButton) {
                    activePriceButton.classList.add('selected');
                }

            } else {
                console.warn("Tipo de usuário incorreto para este arquivo. Redirecionando para login.");
                localStorage.removeItem('tipoUsuario');
                window.location.href = 'login.html';
                return;
            }

            currentConfig = CONFIGURACOES_USUARIO[tipoUsuarioAtual][tipoPrecoSelecionado];
            currentPrecosLona = currentConfig.PRECOS_LONA;

            LONA_PADRAO_LARGURA_CORTINA = currentConfig.LARGURA_PADRAO_LONA_GERAL;
            LONA_PADRAO_LARGURA_CAPOTA = currentConfig.LARGURA_PADRAO_LONA_GERAL;

            updateLonaSelectOptions(lonaAnteriormenteSelecionada);
        }
        
        function updateLonaSelectOptions(lonaParaManterSelecionada = null) {
            marcaLonaSelect.innerHTML = '';
            let precosParaExibir = {};

            if (isCompletoSelecionado) {
                if (tipoToldoSelecionado === 'capota') {
                    precosParaExibir = PRECOS_COMPLETO_CAPOTA;
                } else {
                    precosParaExibir = PRECOS_COMPLETO_CORTINA;
                }
            } else {
                precosParaExibir = currentPrecosLona;
            }

            let lonaFoundAndSelected = false;
            for (const marcaPrecoString in precosParaExibir) {
                const option = document.createElement('option');
                option.value = marcaPrecoString;
                option.textContent = marcaPrecoString;
                marcaLonaSelect.appendChild(option);

                if (lonaParaManterSelecionada && marcaPrecoString === lonaParaManterSelecionada) {
                    option.selected = true;
                    lonaFoundAndSelected = true;
                }
            }
            if (!lonaFoundAndSelected) {
                const slLonaKey = Object.keys(precosParaExibir).find(key => key.includes("SL:"));
                if (slLonaKey) {
                    marcaLonaSelect.value = slLonaKey;
                } else if (Object.keys(precosParaExibir).length > 0) {
                    marcaLonaSelect.value = Object.keys(precosParaExibir)[0];
                }
            }
            calcularPreco();
        }

        function handleLonaChange() {
            if (!isCompletoSelecionado) {
                LONA_PADRAO_LARGURA_CORTINA = currentConfig.LARGURA_PADRAO_LONA_GERAL;
                LONA_PADRAO_LARGURA_CAPOTA = currentConfig.LARGURA_PADRAO_LONA_GERAL;

                const selectedOptionText = marcaLonaSelect.options[marcaLonaSelect.selectedIndex].text;
                if (selectedOptionText.includes("Sansuy")) {
                    LONA_PADRAO_LARGURA_CORTINA = currentConfig.LARGURA_PADRAO_LONA_SANSUY;
                    LONA_PADRAO_LARGURA_CAPOTA = currentConfig.LARGURA_PADRAO_LONA_SANSUY;
                }
            }
            calcularPreco();
        }

        function init() {
            loadUserConfig();
            updateMeasureLabel();
            handleLonaChange();
        }

        function updateMeasureLabel() {
            if (tipoToldoSelecionado === 'cortina') {
                medidaSecundariaLabel.textContent = 'Caimento (Sem bandô):';
                medidaSecundariaInput.placeholder = '0,00';
            } else if (tipoToldoSelecionado === 'capota') {
                medidaSecundariaLabel.textContent = 'Perna:';
                medidaSecundariaInput.placeholder = '0,00';
            }
        }

        function calcularPrecoCortina(largura, caimento, precoM2Lona) {
            const pano = Math.ceil((largura - 0.000000000000001) / LONA_PADRAO_LARGURA_CORTINA);
            let metragem = pano * (caimento + 0.10);
            let precoLona = metragem * precoM2Lona;
            let mtrgcos = largura * caimento

            let precoCostura = largura * caimento * currentConfig.CORTINA_COSTURA_M2_RATE;
            
            if (precoCostura < currentConfig.PRECO_MIN_COSTURA_CORTINA) {
                precoCostura = currentConfig.PRECO_MIN_COSTURA_CORTINA;
            }
            return { pano, metragem, precoLona, precoCostura, mtrgcos};
        }

        function calcularPrecoCapota(largura, perna, precoM2Lona) {
            const larg = largura + (2 * perna);
            const pern = 2 * perna;
            const pano = Math.ceil((larg - 0.00000000000001) / LONA_PADRAO_LARGURA_CAPOTA);
            let metragem = pano * pern;
            let precoLona = metragem * precoM2Lona;
            let mtrgcos = largura + (2 * perna);

            let precoCostura = larg * currentConfig.CAPOTA_COSTURA_M2_RATE;

            if (precoCostura < currentConfig.PRECO_MIN_COSTURA_CAPOTA) {
                precoCostura = currentConfig.PRECO_MIN_COSTURA_CAPOTA;
            }
            return { pano, metragem, precoLona, precoCostura, mtrgcos }
        }

        function calcularPreco() {
            const largura = getNumericValue('largura');
            const medidaSecundaria = getNumericValue('medidaSecundaria');

            let custoTotal = 0;
            let resultadoCalculo = { pano: 0, metragem: 0, precoLona: 0, precoCostura: 0, mtrgcos: 0 };
            
            // Verifica se há alguma medida válida
            if (largura > 0 && medidaSecundaria > 0) {
                const marcaLonaAtualString = marcaLonaSelect.value;
                
                if (isCompletoSelecionado) {
                    let precoLonaBase = 0;
                    
                    if (tipoToldoSelecionado === 'cortina') {
                         precoLonaBase = PRECOS_COMPLETO_CORTINA[marcaLonaAtualString];
                         custoTotal = largura * medidaSecundaria * precoLonaBase;
                    } else if (tipoToldoSelecionado === 'capota') {
                        precoLonaBase = PRECOS_COMPLETO_CAPOTA[marcaLonaAtualString];
                        custoTotal = largura * precoLonaBase;
                    }

                    // Aplica o valor mínimo de 650
                    custoTotal = Math.max(custoTotal, 650);

                    // Preenche o objeto de resultados para exibição
                    resultadoCalculo.precoLona = custoTotal;
                    resultadoCalculo.precoCostura = 0;
                    resultadoCalculo.metragem = tipoToldoSelecionado === 'cortina' ? largura * medidaSecundaria : largura;
                    resultadoCalculo.mtrgcos = tipoToldoSelecionado === 'cortina' ? largura * medidaSecundaria : largura;

                } else { // Cálculo padrão
                    const precoM2Lona = currentPrecosLona[marcaLonaAtualString];

                    if (precoM2Lona === undefined) {
                        valorTotalSpan.textContent = "R$ 0,00 (Erro na Lona)";
                        resultDetailsDiv.innerHTML = "Erro: Lona selecionada não encontrada nos preços.";
                        console.error("Lona selecionada não encontrada nos preços da configuração atual.");
                        return;
                    }

                    if (tipoToldoSelecionado === 'cortina') {
                        resultadoCalculo = calcularPrecoCortina(largura, medidaSecundaria, precoM2Lona);
                    } else if (tipoToldoSelecionado === 'capota') {
                        resultadoCalculo = calcularPrecoCapota(largura, medidaSecundaria, precoM2Lona);
                    }
                    custoTotal = resultadoCalculo.precoLona + resultadoCalculo.precoCostura;
                }
            }
            
            valorTotalSpan.textContent = `R$ ${custoTotal.toFixed(2)}`;

            resultDetailsDiv.innerHTML = `
                <div class="spec-item">
                    <strong>Pano: ${resultadoCalculo.pano.toFixed(0)}</strong>
                </div>
                <div class="spec-item">
                    <strong>Mtrg(Lona): ${resultadoCalculo.metragem.toFixed(2)} m²</strong>
                </div>
                <div class="spec-item">
                    <strong>Mtrg(Cos): ${resultadoCalculo.mtrgcos.toFixed(2)} m²</strong>
                </div>
                <div class="spec-item">
                    <strong>Prç(Lona): R$ ${resultadoCalculo.precoLona.toFixed(2)}</strong>
                </div>
                <div class="spec-item">
                    <strong>Prç(cos): R$ ${resultadoCalculo.precoCostura.toFixed(2)}</strong>
                </div>
                
            `;
        }
        
        function handleToldoClick(event) {
            const clickedButton = event.currentTarget;
            const dataType = clickedButton.dataset.type;
            
            if (dataType === 'completo') {
                isCompletoSelecionado = !isCompletoSelecionado;
                clickedButton.classList.toggle('selected', isCompletoSelecionado);
            } else { // Clicou em Cortina ou Capota
                if (isCompletoSelecionado) {
                    // Se o modo 'Completo' está ativo, apenas alterna entre Cortina e Capota
                    tipoCortinaButton.classList.remove('selected');
                    tipoCapotaButton.classList.remove('selected');
                    clickedButton.classList.add('selected');
                    tipoToldoSelecionado = dataType;
                } else {
                    // Se o modo 'Completo' NÃO está ativo, funciona como antes (seleção exclusiva)
                    tipoCortinaButton.classList.remove('selected');
                    tipoCapotaButton.classList.remove('selected');
                    tipoCompletoButton.classList.remove('selected');
                    clickedButton.classList.add('selected');
                    tipoToldoSelecionado = dataType;
                }
            }

            updateLonaSelectOptions();
            updateMeasureLabel();
        }

        // --- Event Listeners ---
        marcaLonaSelect.addEventListener('change', handleLonaChange);

        tipoToldoButtons.forEach(button => {
            button.addEventListener('click', handleToldoClick);
        });

        precoButtons.forEach(button => {
            button.addEventListener('click', () => {
                precoButtons.forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                tipoPrecoSelecionado = button.dataset.priceType;
                loadUserConfig();
                handleLonaChange();
            });
        });

        // Adiciona event listeners para os inputs para recalcular ao digitar
        larguraInput.addEventListener('input', calcularPreco);
        medidaSecundariaInput.addEventListener('input', calcularPreco);

        btnVerPaleta.addEventListener('click', () => {
            const selectedOptionText = marcaLonaSelect.value;
            if (!selectedOptionText) return;

            // Extrai o nome da marca do texto da opção (ex: "Sansuy: R$ 35,70")
            const brandName = selectedOptionText.split(':')[0].toLowerCase().trim();
            const paletteFile = paletaMap[brandName];

            if (paletteFile) {
                // Abre o PDF correspondente em uma nova aba
                window.open(paletteFile, '_blank');
            } else {
                alert(`Paleta de cores para a marca "${brandName}" não encontrada.`);
            }
        });

        // Inicializa a calculadora quando o DOM estiver completamente carregado
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>