<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerar Orçamento</title>
    <link rel="icon" type="image/png" href="IMG/imgfavicon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- ESTILOS CSS GERAIS E ANIMAÇÕES --- */
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            color: #333;
            background-image: url(IMG/imgsalvati.png);
            background-size: cover;
            background-position: center center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            overflow: hidden;
            position: relative;
            opacity: 0;
            transform: scale(1.05);
            animation: fadeZoomIn 1.0s ease-out forwards;
        }

        @keyframes fadeZoomIn {
            from { opacity: 0; transform: scale(1.05); }
            to { opacity: 1; transform: scale(1); }
        }

        body.fade-zoom-out {
            animation: fadeZoomOut 0.55s ease-in forwards;
        }

        @keyframes fadeZoomOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }

        body.modal-open {
            overflow: hidden;
        }

        /* --- ESTILOS DO CONTAINER PRINCIPAL --- */
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 900px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            max-height: 95vh;
            overflow-y: auto;
        }

        /* --- ESTILOS DO CABEÇALHO --- */
        .header-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .logo-wrapper {
            flex-shrink: 0;
        }

        .logo-wrapper img {
            max-height: 150px;
            width: auto;
        }

        .company-info {
            text-align: left;
            font-size: 0.9em;
            line-height: 1.2;
            margin-left: 20px;
        }

        .company-info p {
            margin: 0;
        }

        /* --- ESTILOS PARA INFORMAÇÕES DE VENDA --- */
        .sale-info {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            gap: 5px;
            font-weight: bold;
        }

        /* --- ESTILOS PARA INFORMAÇÕES DO CLIENTE E QUADRADO DE ASSINATURA --- */
        .client-section {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .client-info {
            flex: 1;
        }
        
        .client-info-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .client-info-row label {
            font-weight: bold;
            width: 80px;
            position: relative;
        }
        
        .client-info-row label.required::after {
            content: '*';
            color: red;
            position: absolute;
            top: 0;
            right: -10px;
        }

        .client-info-row input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .client-info-row input:invalid:required {
            border-color: red;
        }
        
        .error-message {
            color: red;
            font-size: 0.8em;
            margin-left: 90px;
            display: none;
        }
        
        .signature-box {
            flex-shrink: 0;
            width: 350px;
            padding: 15px;
            border: 2px solid #333;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .signature-box p {
            margin: 0;
            text-align: center;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .signature-lines {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: auto;
        }

        .signature-line {
            border-bottom: 1px solid #333;
            padding-top: 5px;
            position: relative;
        }

        .signature-line span {
            font-weight: bold;
            font-size: 0.8em;
        }
        
        /* --- ESTILOS PARA INFORMAÇÕES DO VENDEDOR --- */
        .seller-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }

        .seller-info-content {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: bold;
        }

        .seller-info .signature-line {
            flex-grow: 1;
            border-bottom: 1px solid #333;
            position: relative;
        }
        
        .seller-info .signature-line span {
            font-weight: bold;
            font-size: 0.8em;
        }

        /* --- ESTILOS PARA DETALHES DA COMPRA --- */
        .purchase-details {
            border: 2px solid #00aaff;
            border-radius: 15px;
            padding: 15px;
            margin-top: 30px;
            text-align: center;
        }

        .purchase-details h3 {
            margin-top: 0;
            color: #00aaff;
        }
        
        .purchase-details textarea {
            width: 100%;
            height: 80px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-sizing: border-box;
            resize: none;
            overflow: hidden;
            text-align: left;
            font-size: 1em;
            font-weight: normal;
        }
        
        .purchase-details textarea.bold {
            font-weight: bold;
        }

        /* --- ESTILOS PARA DADOS DO PEDIDO --- */
        .order-data {
            margin-top: 30px;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }

        .order-header h3 {
            margin: 0;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .price-mode-buttons {
            display: flex;
            gap: 5px;
            margin-left: auto;
        }

        .button {
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }
        
        .select-product-button {
            background-color: #007bff;
            color: white;
        }
        
        .select-product-button:hover {
            background-color: #0056b3;
        }
        
        .seller-button {
            background-color: white;
            color: #333;
            border: 1px solid #ccc;
        }
        
        .seller-button:hover {
            background-color: #f0f0f0;
        }
        
        .price-button {
            border: 1px solid #ccc;
            background-color: #f8f9fa;
            color: #333;
        }

        .price-button.active {
            background-color: #007bff;
            color: white;
        }
        
        .price-button:hover:not(.active) {
            background-color: #e2e6ea;
        }

        .order-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .order-table th, .order-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .order-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        .order-table th:first-child, .order-table td:first-child { width: 40px; text-align: center; }
        .order-table th:last-child, .order-table td:last-child { width: 50px; text-align: center; }
        .order-table th:nth-child(3), .order-table td:nth-child(3) { width: 80px; text-align: center; }
        .order-table th:nth-child(4), .order-table td:nth-child(4) { width: 120px; }
        .order-table th:nth-child(5), .order-table td:nth-child(5) { width: 120px; }
        .order-table td:nth-child(2) { max-width: 200px; }
        .order-table td input[type="text"] { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }

        .order-item.removed {
            background-color: #ffebe9 !important;
            color: #8c2f33;
            text-decoration: line-through;
        }
        
        .more-options-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            position: relative;
        }
        
        .more-options-btn i {
            transform: scale(0.9);
        }

        .options-menu {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            z-index: 10;
            min-width: 120px;
            padding: 5px 0;
        }
        
        .options-menu button {
            display: block;
            width: 100%;
            text-align: left;
            padding: 8px 12px;
            background: none;
            border: none;
            cursor: pointer;
        }
        
        .options-menu button:hover {
            background-color: #f0f0f0;
        }

        .totals-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #333;
            display: flex;
            justify-content: flex-end;
            gap: 50px;
            flex-wrap: wrap;
        }

        .totals-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
            min-width: 250px;
        }
        
        .total-row {
            display: flex;
            justify-content: space-between;
            width: 100%;
            font-size: 1.1em;
        }

        .total-row span:first-child {
            font-weight: bold;
        }

        .grand-total {
            font-size: 1.4em;
            font-weight: bold;
            color: #007bff;
        }
        
        .remaining-total {
            color: red;
            font-weight: bold;
            font-size: 0.9em;
            margin-top: -5px;
        }
        
        .discount-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            gap: 10px;
        }
        
        .discount-row label {
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .discount-row input {
            width: 100px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .discount-type-btn {
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f8f9fa;
            cursor: pointer;
            width: 40px;
            text-align: center;
        }
        
        .payments-section {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 400px;
            margin-right: auto;
        }
        
        .payments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .payments-header .add-payment-btn {
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .payment-input-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            justify-content: flex-end;
            width: 100%;
        }
        
        .payment-input-group input.value-input {
            width: 120px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .payment-input-group select {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .remove-payment-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.9em;
        }

        /* --- ESTILO PARA OS BOTÕES FIXOS --- */
        .fixed-buttons {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .top-fixed-buttons {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            z-index: 10;
        }
        
        .top-fixed-buttons .right {
            display: flex;
            gap: 10px;
        }

        .fixed-buttons .button, .top-fixed-buttons .button {
            padding: 10px 15px;
            font-size: 0.9em;
            text-decoration: none;
            display: inline-block;
        }
        
        #loadButton {
            background-color: #17a2b8;
            color: white;
        }
        
        #saveButton {
            background-color: #28a745;
            color: white;
        }
        
        #downloadButton {
            background-color: #6c757d;
            color: white;
        }
        
        #backToMenuButton {
            background-color: #dc3545;
            color: white;
        }
        
        #loadButton:hover { background-color: #138496; }
        #saveButton:hover { background-color: #218838; }
        #downloadButton:hover { background-color: #5a6268; }
        #backToMenuButton:hover { background-color: #c82333; }

        /* --- ESTILOS DA JANELA MODAL DE PRODUTOS E CARREGAMENTO--- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 20px;
            border: 1px solid #888;
            width: 90%;
            max-width: 800px;
            border-radius: 10px;
            position: relative;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }
        
        .modal-content.quantity {
            max-width: 350px;
            text-align: center;
        }
        
        .modal-content.load-screen {
            max-width: 600px;
        }
        
        .load-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
        }
        
        .load-list-item:hover {
            background-color: #f8f9fa;
        }
        
        .load-list-item h4 {
            margin: 0;
            font-size: 1em;
            flex-grow: 1;
        }
        
        .load-list-item .item-buttons {
            display: flex;
            gap: 10px;
            flex-shrink: 0;
        }

        .load-footer {
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .load-footer button {
            background-color: #dc3545;
            color: white;
        }
        
        .load-footer button:hover {
            background-color: #c82333;
        }
        
        .close-button {
            position: absolute;
            top: 5px;
            right: 5px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            line-height: 1;
            padding: 10px;
            cursor: pointer;
            background: transparent;
            border: none;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        
        .search-title {
            color: #007bff;
            font-size: 1.5em;
            margin-bottom: 15px;
            text-align: center;
        }

        .search-container {
            position: relative;
            margin-bottom: 15px;
        }

        .search-input {
            width: 100%;
            padding: 10px 40px 10px 10px;
            border: 1px solid #007bff;
            border-radius: 5px;
            box-sizing: border-box;
            text-align: left;
            font-size: 1.1em;
        }
        
        .search-input::placeholder {
            text-align: left;
        }
        
        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #007bff;
            font-size: 1.2em;
        }

        .modal-table-container {
            flex-grow: 1;
            overflow-y: auto;
            border: 1px solid #ccc;
            border-radius: 8px;
        }

        .modal-product-table {
            width: 100%;
            border-collapse: collapse;
        }

        .modal-product-table th, .modal-product-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .modal-product-table th {
            background-color: #f8f9fa;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        .modal-product-table th:first-child { border-top-left-radius: 8px; }
        .modal-product-table th:last-child { border-top-right-radius: 8px; }

        .modal-product-table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .modal-product-table tbody tr:hover {
            background-color: #f0f0f0;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 10px;
            gap: 5px;
        }
        
        .pagination button {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .pagination button.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* --- Barra de Notificação --- */
        #notification-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            padding: 15px;
            text-align: center;
            color: white;
            font-weight: bold;
            z-index: 1000;
            display: none;
            animation: slideIn 0.5s ease-out forwards;
        }
        
        #notification-bar.success { background-color: #28a745; }
        #notification-bar.error { background-color: #dc3545; }

        @keyframes slideIn {
            from { top: -60px; }
            to { top: 0; }
        }

        /* --- Estilo do Input de Quantidade --- */
        .modal-content.quantity #quantity-input {
            width: 100%;
            max-width: 150px;
            padding: 10px;
            font-size: 1.2em;
            text-align: center;
            border: 2px solid #007bff;
            border-radius: 8px;
        }
        
        /* --- Estilo do Modal de Senha --- */
        .modal-content.password {
            max-width: 400px;
            text-align: center;
        }
        
        .modal-content.password input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        /* --- ESTILOS PARA GERAÇÃO DE PDF --- */
        /* Classe aplicada temporariamente para formatar o conteúdo para o PDF */
        .pdf-generation-mode {
            /* Garante que todos os elementos calculem seu tamanho de forma previsível */
            *, *::before, *::after {
                box-sizing: border-box !important;
                /* Garante que textos longos quebrem a linha e não estourem o layout */
                overflow-wrap: break-word !important;
            }

            /* Reseta o body para um fluxo de documento normal, sem centralização ou overflow */
            display: block !important;
            overflow: visible !important;
            height: auto !important;
            min-height: 0 !important;
            padding: 0 !important; /* A margem será controlada pela biblioteca de PDF */
            margin: 0 !important;
            background: none !important;
            animation: none !important;
        }

        .pdf-generation-mode .container {
            /* Força o container a expandir para mostrar todo o conteúdo, eliminando a barra de rolagem */
            max-height: none !important;
            height: auto !important;
            overflow-y: visible !important; /* Garante que o conteúdo vertical não seja cortado */
            overflow-x: hidden !important;  /* Impede que o conteúdo vaze para os lados, resolvendo o corte */
            /* Reseta estilos visuais para um PDF limpo */
            box-shadow: none !important;
            border: none !important;
            margin: 0 !important;
            padding: 0 !important;
            width: 103.1% !important; /* Compensa a escala para preencher a largura (100 / 0.97) */
            transform: scale(0.97) !important; /* Reduz o tamanho de tudo em 3% */
            transform-origin: top left !important; /* Garante que a escala seja aplicada a partir do canto superior esquerdo */
        }

        /* Esconde todos os elementos de interface que não devem aparecer no PDF */
        .pdf-generation-mode .top-fixed-buttons,
        .pdf-generation-mode .fixed-buttons,
        .pdf-generation-mode .order-header .button-group,
        .pdf-generation-mode .price-mode-buttons,
        .pdf-generation-mode .more-options-btn,
        .pdf-generation-mode .add-payment-btn,
        .pdf-generation-mode .remove-payment-btn,
        .pdf-generation-mode .options-menu,
        .pdf-generation-mode .close-button,
        .pdf-generation-mode .modal { /* Esconde também qualquer modal que possa estar aberto */
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="notification-bar"></div>

    <div class="top-fixed-buttons">
        <a href="#" class="button" id="loadButton">Carregar</a>
        <div class="right">
            <a href="#" class="button" id="downloadButton">Baixar PDF</a>
        </div>
    </div>

    <div class="fixed-buttons">
        <a href="#" class="button" id="backToMenuButton" onclick="event.preventDefault(); addExitAnimationAndRedirect('menu.html');">Menu</a>
        <a href="#" class="button" id="saveButton">Salvar</a>
    </div>

    <div class="container">
        <div class="header-wrapper">
            <div class="logo-wrapper">
                <img src="IMG/imglogo.png" alt="Logo da Empresa">
            </div>
            <div class="company-info">
                <p>A S J Izidoro Distribuidora de Lonas e Toldos Ltda</p>
                <p>(SALVATI TOLDOS)</p>
                <p>Estrada do Mendanha, 1660 LOJA A e B - Campo Grande - RJ</p>
                <p>- Cep. 23087-285</p>
                <p>- Tel. (21) 96585-8633</p>
                <p>- CNPJ. 29.303.797/0004-20</p>
            </div>
        </div>

        <div class="sale-info">
            <p id="sale-number"></p>
            <p id="sale-date"></p>
        </div>

        <div class="client-section">
            <div class="client-info">
                <div class="client-info-row">
                    <label for="cliente" class="required">Cliente:</label>
                    <input type="text" id="cliente" required>
                </div>
                <div class="client-info-row">
                    <label for="endereco" id="endereco-label">Endereço:</label>
                    <input type="text" id="endereco">
                </div>
                <div class="client-info-row">
                    <label for="cep" id="cep-label">Cep:</label>
                    <input type="text" id="cep">
                </div>
                <div class="client-info-row">
                    <label for="cpf" id="cpf-label">CPF:</label>
                    <input type="text" id="cpf">
                </div>
                <div class="client-info-row">
                    <label for="celular" id="celular-label">Celular:</label>
                    <input type="text" id="celular">
                </div>
            </div>

            <div class="signature-box">
                <p>RECEBI OS PRODUTOS DISCRIMINADOS NA CIÊNCIA DA CONFERÊNCIA, RESPONSABILIZANDO-ME DO PEDIDO</p>
                <div class="signature-lines">
                    <div class="signature-line"><span>Ass:</span></div>
                    <div class="signature-line"><span>Conferência:</span></div>
                </div>
            </div>
        </div>

        <div class="seller-info">
            <div class="seller-info-content">
                <p>Vendedor: <select id="vendedor" class="button seller-button">
                    <option value="Giulia Salvate" selected>Giulia Salvate</option>
                    <option value="Lucas Salvate">Lucas Salvate</option>
                </select></p>
            </div>
            <div class="signature-line"><span>Ass:</span></div>
        </div>
        
        <div class="purchase-details">
            <h3>Detalhes da compra</h3>
            <textarea id="purchase-details-textarea" placeholder="Adicione os detalhes da compra aqui..."></textarea>
        </div>

        <div class="order-data">
            <div class="order-header">
                <div class="button-group">
                    <button class="button select-product-button" onclick="openProductSelection()">Selecionar Produto</button>
                </div>
                <h3>Dados do pedido</h3>
                <div class="price-mode-buttons">
                    <button class="button price-button active" id="varejo-btn" onclick="setPriceMode('varejo')">Varejo</button>
                    <button class="button price-button" id="atacado-btn" onclick="setPriceMode('atacado')">Atacado</button>
                </div>
            </div>
            
            <table class="order-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Produto / Obs.</th>
                        <th>Qtd.</th>
                        <th>Preço Uni.</th>
                        <th>Total</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="order-items-body">
                    </tbody>
            </table>

            <div class="totals-section">
                <div class="payments-section">
                    <div class="payments-header">
                        <span>Formas de Pagamento</span>
                        <button class="add-payment-btn" onclick="addPaymentRow()">Adicionar</button>
                    </div>
                    <div id="payments-container">
                        </div>
                </div>
                
                <div class="totals-container">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span id="subtotal">R$ 0,00</span>
                    </div>
                    
                    <div class="discount-row">
                        <span>Desconto:</span>
                        <input type="number" id="desconto-valor" value="0" min="0" step="0.01">
                        <button id="desconto-tipo-btn" class="discount-type-btn">R$</button>
                    </div>
                    
                    <div class="total-row">
                        <span>Total:</span>
                        <span id="grand-total">R$ 0,00</span>
                    </div>

                    <div class="total-row">
                        <span class="remaining-total" id="remaining-total">Falta: R$ 0,00</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="product-modal" class="modal">
        <div class="modal-content">
            <button class="close-button" onclick="closeProductModal()">&times;</button>
            <h2 class="search-title">Produtos</h2>
            <div class="search-container">
                <input type="text" id="product-search-input" class="search-input" placeholder="Exemplo: castanha reta">
                <i class="fas fa-search search-icon"></i>
            </div>
            <div class="modal-table-container">
                <table class="modal-product-table">
                    <thead><tr><th>Nome</th><th>Unidade</th><th>Preço Atacado</th><th>Preço Varejo</th></tr></thead>
                    <tbody id="product-list-body"></tbody>
                </table>
            </div>
            <div class="pagination" id="product-pagination"></div>
        </div>
    </div>

    <div id="quantity-modal" class="modal">
        <div class="modal-content quantity">
            <button class="close-button" onclick="closeQuantityModal()">&times;</button>
            <h2>Selecione a quantidade</h2>
            <p id="quantity-product-name"></p>
            <input type="number" id="quantity-input" value="1" min="1">
            <div class="modal-buttons">
                <button class="button select-product-button" onclick="addSelectedItemToOrder()">Adicionar</button>
                <button class="button seller-button" onclick="closeQuantityModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="load-modal" class="modal">
        <div class="modal-content load-screen">
            <button class="close-button" onclick="closeLoadModal()">&times;</button>
            <h2 class="search-title">Carregar Orçamento Salvo</h2>
            <div id="load-list" class="modal-table-container">
                </div>
            <div class="load-footer">
                <button class="button" onclick="openPasswordModal()">Apagar Todos</button>
            </div>
        </div>
    </div>
    
    <div id="password-modal" class="modal">
        <div class="modal-content password">
            <button class="close-button" onclick="closePasswordModal()">&times;</button>
            <h2>Confirmação de Senha</h2>
            <p>Para apagar todas as notas, digite a senha:</p>
            <input type="password" id="password-input" placeholder="Digite a senha aqui">
            <div class="modal-buttons">
                <button class="button select-product-button" onclick="checkPassword()">Confirmar</button>
                <button class="button seller-button" onclick="closePasswordModal()">Cancelar</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="produtos.js"></script>
    <script>
        let priceMode = 'varejo';
        let selectedProduct = null;
        let selectedRowToEdit = null;
        let isDiscountPercent = false;
        let currentPage = 1;
        const itemsPerPage = 10;
        const password = '2217211908As';

        function addExitAnimationAndRedirect(urlDestino) {
            document.body.classList.add('fade-zoom-out');
            setTimeout(() => {
                window.location.href = urlDestino;
            }, 550);
        }

        function generateSaleNumberAndDate() {
            const randomLetter = 'S';
            const randomNumber = Math.floor(100 + Math.random() * 900);
            document.getElementById('sale-number').innerText = `Venda: ${randomLetter}${randomNumber}`;
            const today = new Date();
            const day = String(today.getDate()).padStart(2, '0');
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const year = today.getFullYear();
            document.getElementById('sale-date').innerText = `${day}/${month}/${year}`;
        }

        function formatarValorMonetario(valor) {
            return `R$ ${parseFloat(valor).toFixed(2).replace('.', ',')}`;
        }

        function autoExpandTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = (textarea.scrollHeight) + 'px';
        }

        function showNotification(message, type) {
            const bar = document.getElementById('notification-bar');
            bar.innerText = message;
            bar.className = '';
            bar.classList.add(type);
            bar.style.display = 'block';
            setTimeout(() => {
                bar.style.display = 'none';
            }, 3000);
        }

        function openProductSelection() {
            document.body.classList.add('modal-open');
            renderProductModalList(catalogoProdutos, 1);
            document.getElementById('product-modal').style.display = 'flex';
            document.getElementById('product-search-input').focus();
        }

        function closeProductModal() {
            document.body.classList.remove('modal-open');
            document.getElementById('product-modal').style.display = 'none';
            document.getElementById('product-search-input').value = '';
        }

        function normalizeString(str) {
            return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }
        
        function renderProductModalList(products, page) {
            currentPage = page;
            const listBody = document.getElementById('product-list-body');
            const paginationContainer = document.getElementById('product-pagination');
            
            listBody.innerHTML = '';
            paginationContainer.innerHTML = '';
            
            const totalPages = Math.ceil(products.length / itemsPerPage);
            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const paginatedProducts = products.slice(start, end);

            if (!paginatedProducts || paginatedProducts.length === 0) {
                listBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nenhum produto encontrado.</td></tr>';
                return;
            }
            
            paginatedProducts.forEach(product => {
                if (!product.nome) return;
                const row = document.createElement('tr');
                row.dataset.productId = product.id;
                row.innerHTML = `
                    <td>${product.nome}</td>
                    <td>${product.unidade}</td>
                    <td>${formatarValorMonetario(product.precoAtacado)}</td>
                    <td>${formatarValorMonetario(product.precoVarejo)}</td>
                `;
                listBody.appendChild(row);
            });
            
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.innerText = i;
                if (i === currentPage) {
                    pageButton.classList.add('active');
                }
                pageButton.addEventListener('click', () => {
                    renderProductModalList(products, i);
                });
                paginationContainer.appendChild(pageButton);
            }
        }

        function searchProductsInModal() {
            const searchTerm = normalizeString(document.getElementById('product-search-input').value);
            const filteredProducts = catalogoProdutos.filter(product => {
                const normalizedName = normalizeString(product.nome);
                const normalizedCode = product.codigo ? normalizeString(product.codigo) : '';
                return normalizedName.includes(searchTerm) || normalizedCode.includes(searchTerm);
            });
            renderProductModalList(filteredProducts, 1);
        }

        function openQuantityModal(productId) {
            selectedProduct = catalogoProdutos.find(p => p.id === productId);
            if (!selectedProduct) return;
            document.getElementById('quantity-product-name').innerText = `Produto: ${selectedProduct.nome}`;
            document.getElementById('quantity-modal').style.display = 'flex';
            document.getElementById('quantity-input').value = 1;
            document.getElementById('quantity-input').focus();
        }

        function closeQuantityModal() {
            document.getElementById('quantity-modal').style.display = 'none';
            selectedProduct = null;
            selectedRowToEdit = null;
        }

        function addSelectedItemToOrder() {
            const quantidade = parseFloat(document.getElementById('quantity-input').value);
            if (isNaN(quantidade) || quantidade <= 0) {
                alert("Quantidade inválida.");
                return;
            }

            if (selectedRowToEdit) {
                selectedRowToEdit.dataset.quantidade = quantidade;
                const preco = parseFloat(selectedRowToEdit.dataset.preco);
                const total = preco * quantidade;
                selectedRowToEdit.querySelector('td:nth-child(3)').innerText = quantidade;
                selectedRowToEdit.querySelector('.total-cell').innerText = formatarValorMonetario(total);
                selectedRowToEdit = null;
            } else {
                const product = selectedProduct;
                const orderBody = document.getElementById('order-items-body');
                const preco = priceMode === 'atacado' ? product.precoAtacado : product.precoVarejo;
                const total = preco * quantidade;

                const newRow = document.createElement('tr');
                newRow.classList.add('order-item');
                newRow.dataset.productId = product.id;
                newRow.dataset.quantidade = quantidade;
                newRow.dataset.preco = preco;

                newRow.innerHTML = `
                    <td></td>
                    <td>
                        <div>${product.nome}</div>
                        <input type="text" class="obs-input" placeholder="Observação...">
                    </td>
                    <td>${quantidade}</td>
                    <td>${formatarValorMonetario(preco)}</td>
                    <td class="total-cell">${formatarValorMonetario(total)}</td>
                    <td><button class="more-options-btn"><i class="fas fa-bars"></i></button></td>
                `;
                orderBody.appendChild(newRow);
            }

            closeQuantityModal();
            closeProductModal();
            reindexOrderItems();
            updateTotals();
        }

        function reindexOrderItems() {
            const rows = document.querySelectorAll('#order-items-body .order-item');
            let index = 1;
            rows.forEach(row => {
                if (!row.classList.contains('removed')) {
                    row.querySelector('td:first-child').innerText = index++;
                }
            });
        }

        function updateTotals() {
            const rows = document.querySelectorAll('#order-items-body .order-item:not(.removed)');
            let subtotal = 0;
            rows.forEach(row => {
                const quantidade = parseFloat(row.dataset.quantidade) || 0;
                const preco = parseFloat(row.dataset.preco) || 0;
                subtotal += quantidade * preco;
            });

            const descontoInput = document.getElementById('desconto-valor');
            const descontoTipo = document.getElementById('desconto-tipo-btn').innerText;
            let desconto = parseFloat(descontoInput.value) || 0;

            if (descontoTipo === '%') {
                desconto = subtotal * (desconto / 100);
            }

            const total = subtotal - desconto;

            let totalPaid = 0;
            const paymentValues = document.querySelectorAll('#payments-container .value-input');
            paymentValues.forEach(input => {
                totalPaid += parseFloat(input.value) || 0;
            });

            const remaining = total - totalPaid;

            document.getElementById('subtotal').innerText = formatarValorMonetario(subtotal);
            document.getElementById('grand-total').innerText = formatarValorMonetario(total);
            document.getElementById('remaining-total').innerText = `Falta: ${formatarValorMonetario(remaining)}`;
        }

        function setPriceMode(mode) {
            priceMode = mode;
            document.getElementById('atacado-btn').classList.toggle('active', mode === 'atacado');
            document.getElementById('varejo-btn').classList.toggle('active', mode === 'varejo');
            
            const rows = document.querySelectorAll('#order-items-body .order-item:not(.removed)');
            rows.forEach(row => {
                const productId = parseInt(row.dataset.productId);
                const product = catalogoProdutos.find(p => p.id === productId);
                
                const preco = mode === 'atacado' ? product.precoAtacado : product.precoVarejo;
                const quantidade = parseFloat(row.dataset.quantidade);
                const total = preco * quantidade;
                
                row.dataset.preco = preco;
                row.querySelector('td:nth-child(4)').innerText = formatarValorMonetario(preco);
                row.querySelector('.total-cell').innerText = formatarValorMonetario(total);
            });
            updateTotals();
        }

        function addPaymentRow() {
            const paymentsContainer = document.getElementById('payments-container');
            const newPaymentGroup = document.createElement('div');
            newPaymentGroup.classList.add('payment-input-group');
            newPaymentGroup.innerHTML = `
                <input type="number" class="value-input" placeholder="Valor" min="0" step="0.01">
                <select class="payment-type-select">
                    <option value="pix">Pix</option>
                    <option value="credito">Crédito</option>
                    <option value="debito">Débito</option>
                    <option value="crediario">Crediário</option>
                    <option value="dinheiro">Dinheiro</option>
                </select>
                <select class="card-type-select" style="display:none;">
                    <option value="visa">Visa</option>
                    <option value="mastercard">Mastercard</option>
                    <option value="elo">Elo</option>
                    <option value="outros">Outros</option>
                </select>
                <button class="button remove-payment-btn" onclick="removePaymentRow(this)">Remover</button>
            `;
            paymentsContainer.appendChild(newPaymentGroup);
            
            newPaymentGroup.querySelector('.value-input').addEventListener('input', updateTotals);
            newPaymentGroup.querySelector('.payment-type-select').addEventListener('change', (event) => {
                const cardSelect = event.target.nextElementSibling;
                if (event.target.value === 'credito' || event.target.value === 'debito') {
                    cardSelect.style.display = 'inline-block';
                } else {
                    cardSelect.style.display = 'none';
                }
                validateFields();
            });
            validateFields();
        }
        
        function removePaymentRow(button) {
            button.closest('.payment-input-group').remove();
            updateTotals();
            validateFields();
        }
        
        function validateFields() {
            const formaPagamentoSelects = document.querySelectorAll('.payment-type-select');
            let isCrediarioSelected = false;
            formaPagamentoSelects.forEach(select => {
                if (select.value === 'crediario') {
                    isCrediarioSelected = true;
                }
            });

            const clienteInput = document.getElementById('cliente');
            const enderecoInput = document.getElementById('endereco');
            const cepInput = document.getElementById('cep');
            const cpfInput = document.getElementById('cpf');
            const celularInput = document.getElementById('celular');
            
            clienteInput.required = true;
            
            if (isCrediarioSelected) {
                enderecoInput.required = true;
                cepInput.required = true;
                cpfInput.required = true;
                celularInput.required = true;
                document.getElementById('endereco-label').classList.add('required');
                document.getElementById('cep-label').classList.add('required');
                document.getElementById('cpf-label').classList.add('required');
                document.getElementById('celular-label').classList.add('required');
            } else {
                enderecoInput.required = false;
                cepInput.required = false;
                cpfInput.required = false;
                celularInput.required = false;
                document.getElementById('endereco-label').classList.remove('required');
                document.getElementById('cep-label').classList.remove('required');
                document.getElementById('cpf-label').classList.remove('required');
                document.getElementById('celular-label').classList.remove('required');
            }

            const remainingText = document.getElementById('remaining-total').innerText;
            const remainingValue = parseFloat(remainingText.replace(/[^0-9,-]+/g,"").replace(',', '.'));
            return document.getElementById('cliente').value.trim() !== '' && Math.abs(remainingValue) < 0.01 && (isCrediarioSelected ? enderecoInput.value.trim() !== '' && cepInput.value.trim() !== '' && cpfInput.value.trim() !== '' && celularInput.value.trim() !== '' : true);
        }

        function saveOrder() {
            if (!validateFields()) {
                showNotification("Não foi possível salvar o orçamento. Verifique se todos os campos obrigatórios estão preenchidos e se o valor total foi pago.", "error");
                return;
            }

            const cliente = document.getElementById('cliente').value;
            const saleNumber = document.getElementById('sale-number').innerText;

            const orderData = {
                saleNumber: saleNumber,
                cliente: cliente,
                data: document.getElementById('sale-date').innerText,
                endereco: document.getElementById('endereco').value,
                cep: document.getElementById('cep').value,
                cpf: document.getElementById('cpf').value,
                celular: document.getElementById('celular').value,
                vendedor: document.getElementById('vendedor').value,
                detalhes: document.querySelector('.purchase-details textarea').value,
                priceMode: priceMode,
                descontoValor: document.getElementById('desconto-valor').value,
                descontoTipo: document.getElementById('desconto-tipo-btn').innerText,
                items: [],
                payments: []
            };

            document.querySelectorAll('#order-items-body .order-item').forEach(row => {
                orderData.items.push({
                    productId: row.dataset.productId,
                    quantidade: row.dataset.quantidade,
                    preco: row.dataset.preco,
                    obs: row.querySelector('.obs-input').value,
                    removed: row.classList.contains('removed')
                });
            });

            document.querySelectorAll('#payments-container .payment-input-group').forEach(group => {
                const valor = group.querySelector('.value-input').value;
                const tipo = group.querySelector('.payment-type-select').value;
                const cartao = group.querySelector('.card-type-select').value;
                orderData.payments.push({ valor, tipo, cartao });
            });

            localStorage.setItem(`orcamento_${saleNumber}_${cliente}`, JSON.stringify(orderData));
            showNotification("Orçamento salvo com sucesso!", "success");
        }
        
        function openLoadModal() {
            document.body.classList.add('modal-open');
            const loadModal = document.getElementById('load-modal');
            const loadList = document.getElementById('load-list');
            loadList.innerHTML = '';
            
            const savedOrçamentos = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('orcamento_')) {
                    const data = JSON.parse(localStorage.getItem(key));
                    savedOrçamentos.push(data);
                }
            }

            if (savedOrçamentos.length === 0) {
                loadList.innerHTML = '<p style="text-align: center;">Nenhum orçamento salvo encontrado.</p>';
            } else {
                savedOrçamentos.forEach(orcamento => {
                    const item = document.createElement('div');
                    item.classList.add('load-list-item');
                    item.innerHTML = `
                        <h4>${orcamento.cliente} - ${orcamento.saleNumber}</h4>
                        <div class="item-buttons">
                            <button class="button select-product-button" onclick="loadSelectedOrder(event, '${orcamento.saleNumber}', '${orcamento.cliente}')">Carregar</button>
                            <button class="button download-button">Baixar PDF</button>
                        </div>
                    `;
                    loadList.appendChild(item);
                });
            }

            loadModal.style.display = 'flex';
        }

        function closeLoadModal() {
            document.body.classList.remove('modal-open');
            document.getElementById('load-modal').style.display = 'none';
        }

        function loadSelectedOrder(event, saleNumber, cliente) {
            event.stopPropagation();
            const key = `orcamento_${saleNumber}_${cliente}`;
            const data = JSON.parse(localStorage.getItem(key));
            
            if (!data) {
                showNotification("Orçamento não encontrado.", "error");
                return;
            }
            
            document.getElementById('sale-number').innerText = data.saleNumber;
            document.getElementById('sale-date').innerText = data.data;
            document.getElementById('cliente').value = data.cliente;
            document.getElementById('endereco').value = data.endereco;
            document.getElementById('cep').value = data.cep;
            document.getElementById('cpf').value = data.cpf;
            document.getElementById('celular').value = data.celular;
            document.getElementById('vendedor').value = data.vendedor;
            document.querySelector('.purchase-details textarea').value = data.detalhes;
            document.getElementById('desconto-valor').value = data.descontoValor;
            document.getElementById('desconto-tipo-btn').innerText = data.descontoTipo;
            isDiscountPercent = data.descontoTipo === '%';

            const orderBody = document.getElementById('order-items-body');
            orderBody.innerHTML = '';
            data.items.forEach(item => {
                const product = catalogoProdutos.find(p => p.id === parseInt(item.productId));
                if (!product) return;

                const newRow = document.createElement('tr');
                newRow.classList.add('order-item');
                if (item.removed) newRow.classList.add('removed');
                newRow.dataset.productId = product.id;
                newRow.dataset.quantidade = item.quantidade;
                newRow.dataset.preco = item.preco;

                newRow.innerHTML = `
                    <td></td>
                    <td>
                        <div>${product.nome}</div>
                        <input type="text" class="obs-input" placeholder="Observação..." value="${item.obs}">
                    </td>
                    <td>${item.quantidade}</td>
                    <td>${formatarValorMonetario(item.preco)}</td>
                    <td class="total-cell">${formatarValorMonetario(item.preco * item.quantidade)}</td>
                    <td><button class="more-options-btn"><i class="fas fa-bars"></i></button></td>
                `;
                orderBody.appendChild(newRow);
            });

            const paymentsContainer = document.getElementById('payments-container');
            paymentsContainer.innerHTML = '';
            data.payments.forEach(payment => {
                addPaymentRow();
                const lastGroup = paymentsContainer.lastElementChild;
                lastGroup.querySelector('.value-input').value = payment.valor;
                lastGroup.querySelector('.payment-type-select').value = payment.tipo;
                if (payment.tipo === 'credito' || payment.tipo === 'debito') {
                    lastGroup.querySelector('.card-type-select').style.display = 'inline-block';
                    lastGroup.querySelector('.card-type-select').value = payment.cartao;
                }
            });
            
            setPriceMode(data.priceMode);
            validateFields();
            reindexOrderItems();
            updateTotals();
            closeLoadModal();
            showNotification("Orçamento carregado com sucesso!", "success");
        }
        
        function openPasswordModal() {
            document.getElementById('password-modal').style.display = 'flex';
            document.getElementById('password-input').focus();
        }
        
        function closePasswordModal() {
            document.getElementById('password-modal').style.display = 'none';
            document.getElementById('password-input').value = '';
        }
        
        function checkPassword() {
            const inputPassword = document.getElementById('password-input').value;
            if (inputPassword === password) {
                deleteAllNotes();
                closePasswordModal();
            } else {
                showNotification("Senha incorreta.", "error");
                document.getElementById('password-input').value = '';
                document.getElementById('password-input').focus();
            }
        }
        
        function deleteAllNotes() {
            let notesDeleted = 0;
            for (let i = localStorage.length - 1; i >= 0; i--) {
                const key = localStorage.key(i);
                if (key.startsWith('orcamento_')) {
                    localStorage.removeItem(key);
                    notesDeleted++;
                }
            }
            showNotification(`Foram apagadas ${notesDeleted} notas.`, "success");
            closeLoadModal();
        }
        
        function generatePDF() {
            const element = document.querySelector('.container');
            document.body.classList.add('pdf-generation-mode');

            // Usa um pequeno timeout para garantir que o navegador aplique os novos estilos de PDF
            // antes de iniciar a captura. Isso corrige o problema da "primeira página em branco".
            setTimeout(() => {
                const options = {
                    margin: 10, /* Define uma margem de 10mm em todos os lados do PDF */
                    filename: 'orçamento.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        logging: false
                    },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };

                html2pdf().from(element).set(options).save().then(() => {
                    document.body.classList.remove('pdf-generation-mode');
                }).catch((err) => {
                    console.error("Erro ao gerar PDF:", err);
                    document.body.classList.remove('pdf-generation-mode');
                });
            }, 10);
        }


        document.addEventListener('DOMContentLoaded', () => {
            generateSaleNumberAndDate();
            const textarea = document.getElementById('purchase-details-textarea');
            textarea.addEventListener('input', () => autoExpandTextarea(textarea));
            autoExpandTextarea(textarea);
            
            // Evento para negrito (Ctrl+B)
            textarea.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'b') {
                    e.preventDefault();
                    document.execCommand('bold');
                }
            });

            document.getElementById('product-search-input').addEventListener('keyup', searchProductsInModal);
            document.getElementById('product-list-body').addEventListener('click', (event) => {
                const row = event.target.closest('tr');
                if (row && row.dataset.productId) {
                    openQuantityModal(parseInt(row.dataset.productId));
                }
            });

            document.getElementById('order-items-body').addEventListener('click', (event) => {
                const button = event.target.closest('.more-options-btn');
                if (button) {
                    const row = button.closest('tr');
                    const existingMenu = row.querySelector('.options-menu');
                    if (existingMenu) {
                        existingMenu.remove();
                        return;
                    }
                    
                    const menu = document.createElement('div');
                    menu.classList.add('options-menu');
                    menu.innerHTML = `
                        <button onclick="editItem(this)">Editar</button>
                        <button onclick="removeItem(this)">Excluir</button>
                    `;
                    button.appendChild(menu);
                    menu.style.display = 'block';
                } else {
                    document.querySelectorAll('.options-menu').forEach(menu => menu.remove());
                }
            });
            
            document.addEventListener('click', (event) => {
                if (!event.target.closest('.more-options-btn') && !event.target.closest('.options-menu')) {
                    document.querySelectorAll('.options-menu').forEach(menu => menu.remove());
                }
            });

            document.getElementById('desconto-valor').addEventListener('input', updateTotals);
            document.getElementById('desconto-tipo-btn').addEventListener('click', () => {
                const btn = document.getElementById('desconto-tipo-btn');
                if (btn.innerText === 'R$') {
                    btn.innerText = '%';
                } else {
                    btn.innerText = 'R$';
                }
                updateTotals();
            });
            
            document.getElementById('payments-container').addEventListener('input', updateTotals);
            
            document.getElementById('saveButton').addEventListener('click', saveOrder);
            document.getElementById('loadButton').addEventListener('click', openLoadModal);
            document.getElementById('downloadButton').addEventListener('click', generatePDF);


            addPaymentRow();
            validateFields();
            setPriceMode('varejo');
        });
        
        function editItem(button) {
            const row = button.closest('tr');
            selectedRowToEdit = row;
            const currentQuantity = parseFloat(row.dataset.quantidade);
            const productId = parseInt(row.dataset.productId);
            const product = catalogoProdutos.find(p => p.id === productId);

            document.getElementById('quantity-product-name').innerText = `Produto: ${product.nome}`;
            document.getElementById('quantity-input').value = currentQuantity;
            document.getElementById('quantity-modal').style.display = 'flex';
            document.getElementById('quantity-input').focus();
            
            button.closest('.options-menu').remove();
        }

        function removeItem(button) {
            const row = button.closest('tr');
            if (row.classList.contains('removed')) {
                row.classList.remove('removed');
            } else {
                row.classList.add('removed');
            }
            reindexOrderItems();
            updateTotals();
            button.closest('.options-menu').remove();
        }
    </script>
</body>
</html>
